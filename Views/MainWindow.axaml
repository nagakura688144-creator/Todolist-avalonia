<!-- Views/MainWindow.axaml -->
<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        x:Class="TodoApp.Views.MainWindow"
        Width="900" Height="640"
        Title="TodoApp">

  <!-- ===== リソース ===== -->
  <Window.Resources>
    <SolidColorBrush x:Key="ClrInputBg"     Color="#F3F4F6"/>
    <SolidColorBrush x:Key="ClrInputBorder" Color="#D1D5DB"/>
    <SolidColorBrush x:Key="ClrText"        Color="#111827"/>
    <SolidColorBrush x:Key="ClrBtnHover"    Color="#E5E7EB"/>
    <SolidColorBrush x:Key="ClrItemBg"      Color="#FBFBFB"/>
    <SolidColorBrush x:Key="ClrFocusBorder" Color="#93C5FD"/>
  </Window.Resources>

  <!-- ===== 共通スタイル ===== -->
  <Window.Styles>
    <Style Selector="Button">
      <Setter Property="Background"   Value="{StaticResource ClrInputBg}"/>
      <Setter Property="BorderBrush"  Value="{StaticResource ClrInputBorder}"/>
      <Setter Property="Foreground"   Value="{StaticResource ClrText}"/>
      <Setter Property="CornerRadius" Value="8"/>
      <Setter Property="Padding"      Value="10,6"/>
    </Style>
    <Style Selector="Button:pointerover">
      <Setter Property="Background" Value="{StaticResource ClrBtnHover}"/>
    </Style>

    <Style Selector="ToggleButton">
      <Setter Property="Background"   Value="{StaticResource ClrInputBg}"/>
      <Setter Property="BorderBrush"  Value="{StaticResource ClrInputBorder}"/>
      <Setter Property="Foreground"   Value="{StaticResource ClrText}"/>
      <Setter Property="CornerRadius" Value="8"/>
      <Setter Property="Padding"      Value="8,6"/>
    </Style>
    <Style Selector="ToggleButton:pointerover">
      <Setter Property="Background" Value="{StaticResource ClrBtnHover}"/>
    </Style>

    <Style Selector="TextBox">
      <Setter Property="Foreground"   Value="{StaticResource ClrText}"/>
      <Setter Property="Background"   Value="{StaticResource ClrInputBg}"/>
      <Setter Property="BorderBrush"  Value="{StaticResource ClrInputBorder}"/>
      <Setter Property="CornerRadius" Value="8"/>
      <Setter Property="Padding"      Value="10,8"/>
    </Style>
    <Style Selector="TextBox:focus">
      <Setter Property="Foreground"   Value="{StaticResource ClrText}"/>
      <Setter Property="Background"   Value="{StaticResource ClrInputBg}"/>
      <Setter Property="BorderBrush"  Value="{StaticResource ClrFocusBorder}"/>
    </Style>

    <Style Selector="DatePicker TextBox">
      <Setter Property="Foreground"  Value="{StaticResource ClrText}"/>
      <Setter Property="Background"  Value="{StaticResource ClrInputBg}"/>
      <Setter Property="BorderBrush" Value="{StaticResource ClrInputBorder}"/>
    </Style>
    <Style Selector="DatePicker TextBox:focus">
      <Setter Property="BorderBrush" Value="{StaticResource ClrFocusBorder}"/>
    </Style>
  </Window.Styles>

  <!-- ===== 本体 ===== -->
  <StackPanel Margin="16" Spacing="8">

    <!-- ヘッダー -->
    <DockPanel>
      <TextBlock Text="To-Do" FontSize="22" FontWeight="SemiBold" DockPanel.Dock="Left"/>
      <Border DockPanel.Dock="Right" Width="120" Background="Transparent"/>
    </DockPanel>

    <!-- 入力行 -->
    <StackPanel Orientation="Horizontal" Spacing="8">
      <TextBox Width="400"
               Watermark="Task title"
               Text="{Binding NewTitle}">
        <TextBox.Resources>
          <SolidColorBrush x:Key="TextControlForeground"         Color="#FFFFFF"/>
          <SolidColorBrush x:Key="TextControlForegroundFocused"  Color="#FFFFFF"/>
          <SolidColorBrush x:Key="TextControlCaretBrush"         Color="#FFFFFF"/>
          <SolidColorBrush x:Key="TextControlBackground"         Color="#F3F4F6"/>
          <SolidColorBrush x:Key="TextControlBackgroundFocused"  Color="#F3F4F6"/>
          <SolidColorBrush x:Key="TextControlBorderBrush"        Color="#D1D5DB"/>
          <SolidColorBrush x:Key="TextControlBorderBrushFocused" Color="#93C5FD"/>
          <SolidColorBrush x:Key="ThemeForegroundLowBrush"       Color="#6B7280"/>
        </TextBox.Resources>
        <TextBox.KeyBindings>
          <KeyBinding Command="{Binding AddCommand}" Gesture="Enter"/>
        </TextBox.KeyBindings>
      </TextBox>

      <DatePicker SelectedDate="{Binding NewDueDate}" Width="360">
        <DatePicker.Resources>
          <SolidColorBrush x:Key="ThemeForegroundBrush"      Color="#111827"/>
          <SolidColorBrush x:Key="ThemeForegroundLowBrush"   Color="#374151"/>
          <SolidColorBrush x:Key="TextControlBackground"         Color="#F3F4F6"/>
          <SolidColorBrush x:Key="TextControlBackgroundFocused"  Color="#F3F4F6"/>
          <SolidColorBrush x:Key="TextControlBorderBrush"        Color="#D1D5DB"/>
          <SolidColorBrush x:Key="TextControlBorderBrushFocused" Color="#93C5FD"/>
        </DatePicker.Resources>
      </DatePicker>

      <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
        <Button Content="Add"   Command="{Binding AddCommand}"/>
        <Button Content="Clear" Command="{Binding ClearInputCommand}"/>
      </StackPanel>
    </StackPanel>

    <!-- フィルタとソート -->
    <Grid ColumnDefinitions="*,Auto" Margin="0,4,0,0">
      <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="10">
        <ToggleButton Content="All"       IsChecked="{Binding IsFilterAll, Mode=TwoWay}"/>
        <ToggleButton Content="Active"    IsChecked="{Binding IsFilterActive, Mode=TwoWay}"/>
        <ToggleButton Content="Completed" IsChecked="{Binding IsFilterCompleted, Mode=TwoWay}"/>
      </StackPanel>
      
      <Button Grid.Column="1" 
              Content="{Binding SortButtonText}" 
              Command="{Binding ToggleSortCommand}"
              ToolTip.Tip="Toggle sort order by due date"/>
    </Grid>

    <!-- 一覧 -->
    <ItemsControl ItemsSource="{Binding ViewItems}">
      <ItemsControl.ItemTemplate>
        <DataTemplate>
          <Border Padding="10" Margin="0,6"
                  Background="{StaticResource ClrItemBg}"
                  CornerRadius="10">
            
            <Panel>
              <!-- Normal view mode -->
              <Grid ColumnDefinitions="Auto,*,Auto" VerticalAlignment="Center"
                    IsVisible="{Binding !IsEditing}">

              <Grid Width="16" Height="16" VerticalAlignment="Center">
                <Border CornerRadius="3"
                        BorderBrush="#111827"
                        BorderThickness="1"/>
                <CheckBox IsChecked="{Binding IsCompleted, Mode=TwoWay}"
                          Command="{Binding $parent[Window].DataContext.ToggleCompletedCommand}"
                          CommandParameter="{Binding .}"
                          Background="Transparent"/>
              </Grid>

              <StackPanel Grid.Column="1" Margin="12,0,0,0">
                <TextBlock Text="{Binding Title}"
                           FontSize="14"
                           TextDecorations="{Binding IsCompleted, Converter={StaticResource BoolToTextDecorConverter}}"
                           Opacity="{Binding IsCompleted, Converter={StaticResource BoolToOpacityConverter}}"/>
                <Border Padding="6,2"
                        CornerRadius="999"
                        HorizontalAlignment="Left"
                        Background="{Binding IsOverdue, Converter={StaticResource BoolToBrushConverter}}">
                  <TextBlock Text="{Binding DueLabel}" FontSize="12"/>
                </Border>
              </StackPanel>

              <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8" Margin="12,0,0,0" VerticalAlignment="Center">
                <Button Content="Edit"
                        Command="{Binding $parent[Window].DataContext.EditCommand}"
                        CommandParameter="{Binding .}"/>
                <Button Content="Delete"
                        Command="{Binding $parent[Window].DataContext.DeleteCommand}"
                        CommandParameter="{Binding .}"/>
              </StackPanel>

              </Grid>

              <!-- Editing mode -->
              <Grid ColumnDefinitions="*,Auto,Auto" VerticalAlignment="Center" 
                    IsVisible="{Binding IsEditing}">
              
              <StackPanel Grid.Column="0" Spacing="8">
                <TextBox Text="{Binding EditingTitle, Mode=TwoWay}"
                         Watermark="Task title"
                         MinWidth="300">
                  <TextBox.Resources>
                    <SolidColorBrush x:Key="TextControlForeground"         Color="#111827"/>
                    <SolidColorBrush x:Key="TextControlForegroundFocused"  Color="#111827"/>
                    <SolidColorBrush x:Key="TextControlCaretBrush"         Color="#111827"/>
                    <SolidColorBrush x:Key="TextControlBackground"         Color="#FFFFFF"/>
                    <SolidColorBrush x:Key="TextControlBackgroundFocused"  Color="#FFFFFF"/>
                    <SolidColorBrush x:Key="TextControlBorderBrush"        Color="#93C5FD"/>
                    <SolidColorBrush x:Key="TextControlBorderBrushFocused" Color="#3B82F6"/>
                    <SolidColorBrush x:Key="ThemeForegroundLowBrush"       Color="#9CA3AF"/>
                  </TextBox.Resources>
                </TextBox>
                
                <DatePicker SelectedDate="{Binding EditingDueDate, Mode=TwoWay}"
                            MinWidth="300">
                  <DatePicker.Resources>
                    <SolidColorBrush x:Key="ThemeForegroundBrush"          Color="#111827"/>
                    <SolidColorBrush x:Key="ThemeForegroundLowBrush"       Color="#6B7280"/>
                    <SolidColorBrush x:Key="TextControlBackground"         Color="#FFFFFF"/>
                    <SolidColorBrush x:Key="TextControlBackgroundFocused"  Color="#FFFFFF"/>
                    <SolidColorBrush x:Key="TextControlBorderBrush"        Color="#93C5FD"/>
                    <SolidColorBrush x:Key="TextControlBorderBrushFocused" Color="#3B82F6"/>
                  </DatePicker.Resources>
                </DatePicker>
              </StackPanel>

              <Button Grid.Column="1" 
                      Content="Edit"
                      Command="{Binding $parent[Window].DataContext.SaveEditCommand}"
                      CommandParameter="{Binding .}"
                      Background="#10B981"
                      Foreground="White"
                      Margin="8,0,0,0"
                      ToolTip.Tip="Save changes"/>

              <Button Grid.Column="2" 
                      Content="Cancel"
                      Command="{Binding $parent[Window].DataContext.CancelEditCommand}"
                      CommandParameter="{Binding .}"
                      Background="#EF4444"
                      Foreground="White"
                      Margin="8,0,0,0"
                      ToolTip.Tip="Cancel editing"/>

              </Grid>

            </Panel>

          </Border>
        </DataTemplate>
      </ItemsControl.ItemTemplate>
    </ItemsControl>

  </StackPanel>
</Window>
